name: ğŸ§ æ„å»º Linux å†…æ ¸ (BBRv3/åŸç‰ˆå¯é€‰)

on:
  workflow_dispatch:
    inputs:
      # ç›®æ ‡å¤„ç†å™¨æ¶æ„é€‰æ‹©
      arch:
        description: ç›®æ ‡æ¶æ„
        required: true
        default: x86_64
        type: choice
        options:
          - x86_64
          - arm64
      # BBRv3 æ‹¥å¡æ§åˆ¶ç®—æ³•é›†æˆå¼€å…³
      enable_bbrv3:
        description: ğŸš€ é›†æˆ Google BBRv3 TCP æ‹¥å¡æ§åˆ¶
        required: true
        default: true
        type: boolean
      # ç¼–è¯‘å™¨å·¥å…·é“¾é€‰æ‹©
      compiler:
        description: ğŸ”§ é€‰æ‹©ç¼–è¯‘å™¨
        required: true
        default: gcc-default
        type: choice
        options:
          - gcc-default
          - gcc-15
          - gcc-16
          - clang-17
          - clang-18
          - clang-19
      # è‡ªå®šä¹‰å†…æ ¸ç‰ˆæœ¬åç¼€æ ‡è¯†
      custom_suffix:
        description: ğŸ·ï¸ è‡ªå®šä¹‰ç‰ˆæœ¬åç¼€ (ä»…å°å†™å­—æ¯/æ•°å­—ï¼Œä¸è¶…è¿‡50å­—ç¬¦)
        required: false
        default: ''
        type: string
      # å†…æ ¸é…ç½®è¦†å†™é€‰é¡¹
      disable_unused_configs:
        description: ğŸš« åº”ç”¨ç¦ç”¨é…ç½® (disabled_kernel_configs.txt)
        required: true
        default: false
        type: boolean
      enable_custom_configs:
        description: âœ… åº”ç”¨å¯ç”¨é…ç½® (enabled_kernel_configs.txt)
        required: true
        default: false
        type: boolean
      enable_module_configs:
        description: ğŸ“¦ åº”ç”¨æ¨¡å—é…ç½® (moduled_kernel_configs.txt)
        required: true
        default: false
        type: boolean
      # å†å²è®°å½•æ¸…ç†æ§åˆ¶
      cleanup_history:
        description: ğŸ§¹ æ¸…ç†å†å²å·¥ä½œæµè®°å½•
        required: true
        default: false
        type: boolean
      cleanup_only:
        description: âš ï¸ ä»…æ‰§è¡Œæ¸…ç†ï¼Œä¸æ„å»º
        required: true
        default: false
        type: boolean

# å…¨å±€ç¯å¢ƒå˜é‡é…ç½®
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CCACHE_DIR: /home/runner/.ccache
  CCACHE_MAXSIZE: 2G

jobs:
  # å†å²è®°å½•æ¸…ç†ä»»åŠ¡
  cleanup:
    name: ğŸ§¹ æ¸…ç†ä»»åŠ¡
    if: ${{ inputs.cleanup_history == true || inputs.cleanup_only == true }}
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: åˆ é™¤æ—§å·¥ä½œæµè®°å½•
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 0
      - name: ç¡®è®¤æ¸…ç†å®Œæˆ
        run: echo "âœ… å†å²è®°å½•å·²æ¸…ç†"

  # ä¸»æ„å»ºä»»åŠ¡
  build:
    name: ğŸ”¨ ç¼–è¯‘å†…æ ¸
    needs: cleanup
    if: ${{ always() && inputs.cleanup_only == false && (needs.cleanup.result == 'success' || needs.cleanup.result == 'skipped') }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: write
    steps:
      # ä»£ç æ£€å‡º
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # è¾“å…¥å‚æ•°åˆæ³•æ€§æ ¡éªŒ
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          # æ¶æ„æœ‰æ•ˆæ€§æ£€æŸ¥
          [[ "${{ inputs.arch }}" =~ ^(x86_64|arm64)$ ]] || { echo "âŒ éæ³•æ¶æ„"; exit 1; }
          # ç¼–è¯‘å™¨é€‰é¡¹æœ‰æ•ˆæ€§æ£€æŸ¥
          [[ "${{ inputs.compiler }}" =~ ^(gcc-default|gcc-15|gcc-16|clang-17|clang-18|clang-19)$ ]] || { echo "âŒ éæ³•ç¼–è¯‘å™¨"; exit 1; }
          # arm64 æ¶æ„ä¸æ”¯æŒ GCC 15/16ï¼ˆç¼ºå°‘äº¤å‰ç¼–è¯‘å™¨æ”¯æŒï¼‰
          if [[ "${{ inputs.arch }}" == "arm64" && "${{ inputs.compiler }}" =~ ^gcc-(15|16)$ ]]; then
            echo "âŒ å¯¹äº arm64 æ¶æ„ï¼Œä¸æ”¯æŒé€‰æ‹© GCC 15/16ï¼Œè¯·ä½¿ç”¨ gcc-default æˆ– clangã€‚"
            exit 1
          fi
          # è‡ªå®šä¹‰åç¼€æ ¼å¼æ ¡éªŒ
          SUFFIX="${{ inputs.custom_suffix }}"
          if [[ -n "$SUFFIX" ]]; then
            [[ ${#SUFFIX} -le 50 ]] || { echo "âŒ åç¼€è¶…é•¿"; exit 1; }
            [[ "$SUFFIX" =~ ^[a-z0-9]+$ ]] || { echo "âŒ åç¼€åªèƒ½å°å†™å­—æ¯/æ•°å­—"; exit 1; }
          fi
          # é…ç½®æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
          check_file() {
            if [[ "$1" == "true" && ! -f "$2" ]]; then
              echo "âŒ ç¼ºå°‘ $2"
              exit 1
            fi
          }
          check_file "${{ inputs.disable_unused_configs }}" "disabled_kernel_configs.txt"
          check_file "${{ inputs.enable_custom_configs }}" "enabled_kernel_configs.txt"
          check_file "${{ inputs.enable_module_configs }}" "moduled_kernel_configs.txt"
          echo "âœ… å‚æ•°éªŒè¯é€šè¿‡"

      # æ„å»ºå…ƒæ•°æ®ç”Ÿæˆ
      - name: ç”Ÿæˆæ„å»ºæ ‡è¯†ä¸æ—¶é—´æˆ³
        run: |
          RAND=$(tr -dc 'a-z0-9' < /dev/urandom | head -c8 2>/dev/null)
          echo "RAND_SUFFIX=$RAND" >> "$GITHUB_ENV"
          echo "BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_ENV"

      # ä» kernel.org è·å–æœ€æ–°ç¨³å®šç‰ˆç‰ˆæœ¬å·
      - name: è·å–ä¸Šæ¸¸ç‰ˆæœ¬ä¿¡æ¯
        run: |
          for i in {1..5}; do
            JSON=$(curl -fsSL --retry 3 --retry-delay 5 -H 'User-Agent: Mozilla/5.0' https://www.kernel.org/releases.json 2>/dev/null)
            VERSION=$(echo "$JSON" | jq -r '.latest_stable.version' 2>/dev/null)
            [[ -n "$VERSION" && "$VERSION" != "null" ]] && break
            sleep 5
          done
          # å¤‡ç”¨æ–¹æ¡ˆï¼šä» HTML é¡µé¢è§£æ
          if [[ -z "$VERSION" ]]; then
            VERSION=$(curl -fsSL -H 'User-Agent: Mozilla/5.0' https://www.kernel.org | grep -A1 "stable:" | tail -1 | grep -oP '\d+\.\d+(\.\d+)?')
          fi
          [[ -n "$VERSION" ]] || { echo "âŒ æ— æ³•è·å–å†…æ ¸ç‰ˆæœ¬"; exit 1; }
          echo "KERNEL_VERSION=$VERSION" >> "$GITHUB_ENV"

      # é‡Šæ”¾ GitHub Actions è¿è¡Œå™¨ç£ç›˜ç©ºé—´
      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        run: |
          sudo rm -rf /usr/share/dotnet /opt/hostedtoolcache /usr/local/lib/android /usr/local/graalvm
          df -h

      # å®‰è£…ç¼–è¯‘ä¾èµ–å’Œäº¤å‰ç¼–è¯‘å·¥å…·é“¾
      - name: å®‰è£…åŸºç¡€ä¾èµ–ä¸äº¤å‰ç¼–è¯‘å·¥å…·é“¾
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y git build-essential ccache libncurses-dev libssl-dev libelf-dev \
            bison bc flex rsync debhelper dpkg-dev fakeroot kmod cpio dwarves lz4 zstd xz-utils \
            curl jq openssl initramfs-tools libdw-dev software-properties-common
          # arm64 æ¶æ„é¢å¤–å®‰è£…äº¤å‰ç¼–è¯‘å™¨
          if [[ "${{ inputs.arch }}" == "arm64" ]]; then
            sudo apt-get install -y binutils-aarch64-linux-gnu libc6-dev-arm64-cross
          fi
          # æ·»åŠ æ–°ç‰ˆ GCC å’Œ LLVM æº
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          wget -O /tmp/llvm.sh https://apt.llvm.org/llvm.sh
          chmod +x /tmp/llvm.sh

      # é…ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡
      - name: é…ç½®ç¼–è¯‘å™¨ç¯å¢ƒ
        run: |
          ARCH="${{ inputs.arch }}"
          COMPILER="${{ inputs.compiler }}"
          echo "ARCH=$ARCH" >> "$GITHUB_ENV"

          case "$COMPILER" in
            gcc-default)  GCC_VER=14 ;;
            gcc-15)       GCC_VER=15 ;;
            gcc-16)       GCC_VER=16 ;;
            clang-17)     CLANG_VER=17 ;;
            clang-18)     CLANG_VER=18 ;;
            clang-19)     CLANG_VER=19 ;;
          esac

          if [[ "$COMPILER" == gcc* ]]; then
            if [[ "$ARCH" == "arm64" ]]; then
              # arm64 ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬äº¤å‰ç¼–è¯‘å™¨ï¼ˆæ— ç‰ˆæœ¬å·åç¼€ï¼‰
              sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              echo "CC=aarch64-linux-gnu-gcc" >> "$GITHUB_ENV"
              echo "CXX=aarch64-linux-gnu-g++" >> "$GITHUB_ENV"
              echo "CROSS_COMPILE=aarch64-linux-gnu-" >> "$GITHUB_ENV"
              echo "COMPILER_NAME=GCC (default)" >> "$GITHUB_ENV"
              echo "CACHE_KEY_COMPILER=gcc-default" >> "$GITHUB_ENV"
            else
              # x86_64 ä½¿ç”¨å¸¦ç‰ˆæœ¬å·çš„ GCC
              sudo apt-get install -y gcc-${GCC_VER} g++-${GCC_VER}
              echo "CC=gcc-${GCC_VER}" >> "$GITHUB_ENV"
              echo "CXX=g++-${GCC_VER}" >> "$GITHUB_ENV"
              echo "COMPILER_NAME=GCC ${GCC_VER}" >> "$GITHUB_ENV"
              echo "CACHE_KEY_COMPILER=gcc-${GCC_VER}" >> "$GITHUB_ENV"
            fi
          else
            # Clang ç¼–è¯‘å™¨é…ç½®
            sudo /tmp/llvm.sh ${CLANG_VER}
            sudo apt-get install -y clang-${CLANG_VER} lld-${CLANG_VER} llvm-${CLANG_VER}
            if [[ "$ARCH" == "arm64" ]]; then
              echo "CC=clang-${CLANG_VER} --target=aarch64-linux-gnu" >> "$GITHUB_ENV"
              echo "CXX=clang++-${CLANG_VER} --target=aarch64-linux-gnu" >> "$GITHUB_ENV"
              sudo apt-get install -y gcc-aarch64-linux-gnu
            else
              echo "CC=clang-${CLANG_VER} --target=x86_64-linux-gnu" >> "$GITHUB_ENV"
              echo "CXX=clang++-${CLANG_VER} --target=x86_64-linux-gnu" >> "$GITHUB_ENV"
            fi
            # é…ç½® LLVM å·¥å…·é“¾
            for tool in ar nm strip objcopy objdump readelf; do
              echo "${tool^^}=llvm-${tool}-${CLANG_VER}" >> "$GITHUB_ENV"
            done
            echo "MAKE_ARGS=LLVM=1 LLVM_IAS=1" >> "$GITHUB_ENV"
            echo "COMPILER_NAME=Clang ${CLANG_VER}" >> "$GITHUB_ENV"
            echo "CACHE_KEY_COMPILER=clang-${CLANG_VER}" >> "$GITHUB_ENV"
            echo "/usr/lib/llvm-${CLANG_VER}/bin" >> "$GITHUB_PATH"
          fi

      # ccache ç¼“å­˜ç›®å½•åˆå§‹åŒ–
      - name: é…ç½® ccache
        run: |
          mkdir -p "$CCACHE_DIR"
          echo "/usr/lib/ccache" >> "$GITHUB_PATH"
          ccache --set-config=max_size="$CCACHE_MAXSIZE" --set-config=compression=true

      # æ¢å¤ä¹‹å‰ä¿å­˜çš„ ccache ç¼“å­˜
      - name: æ¢å¤ ccache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: kernel-cache-${{ env.KERNEL_VERSION }}-${{ inputs.enable_bbrv3 }}-${{ env.CACHE_KEY_COMPILER }}-${{ inputs.arch }}
          restore-keys: |
            kernel-cache-${{ env.KERNEL_VERSION }}-${{ inputs.enable_bbrv3 }}-${{ env.CACHE_KEY_COMPILER }}-
            kernel-cache-${{ env.KERNEL_VERSION }}-${{ inputs.enable_bbrv3 }}-
            kernel-cache-${{ env.KERNEL_VERSION }}-

      # å…‹éš†å†…æ ¸æºç ä»“åº“
      - name: è·å–å†…æ ¸æºç 
        run: |
          mkdir -p kernel && cd kernel
          MINOR=$(echo "${{ env.KERNEL_VERSION }}" | grep -oP '^\d+\.\d+')
          if [[ "${{ inputs.enable_bbrv3 }}" == "true" ]]; then
            git clone --depth=1 -b v3 https://github.com/google/bbr.git linux
            echo "SOURCE_TYPE=BBRv3" >> "$GITHUB_ENV"
            echo "FEATURE_TAG=With BBRv3" >> "$GITHUB_ENV"
          else
            git clone --depth=1 -b "linux-$MINOR.y" https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git linux || \
            git clone --depth=1 https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git linux
            echo "SOURCE_TYPE=Stable" >> "$GITHUB_ENV"
            echo "FEATURE_TAG=Vanilla" >> "$GITHUB_ENV"
          fi

      # åŒæ­¥ Makefile ä¸­çš„ç‰ˆæœ¬å·ä¸ç›®æ ‡ç‰ˆæœ¬
      - name: ä¿®æ­£å†…æ ¸ç‰ˆæœ¬å·
        working-directory: kernel/linux
        run: |
          V=$(echo "${{ env.KERNEL_VERSION }}" | cut -d. -f1)
          P=$(echo "${{ env.KERNEL_VERSION }}" | cut -d. -f2)
          S=$(echo "${{ env.KERNEL_VERSION }}" | cut -d. -f3)
          sed -i "s/^VERSION *=.*/VERSION = $V/" Makefile
          sed -i "s/^PATCHLEVEL *=.*/PATCHLEVEL = $P/" Makefile
          [[ -n "$S" ]] && sed -i "s/^SUBLEVEL *=.*/SUBLEVEL = $S/" Makefile

      # åº”ç”¨å†…æ ¸é…ç½®æ–‡ä»¶å’Œè‡ªå®šä¹‰é…ç½®
      - name: åº”ç”¨å†…æ ¸é…ç½®
        working-directory: kernel/linux
        run: |
          if [[ -f "${{ github.workspace }}/kernel.config" ]]; then
            cp "${{ github.workspace }}/kernel.config" .config
          else
            make ARCH=${{ env.ARCH }} defconfig
          fi
          # ç¦ç”¨ç­¾åéªŒè¯ï¼ˆGitHub Actions ç¯å¢ƒæ— å¯†é’¥ï¼‰
          scripts/config --disable SYSTEM_TRUSTED_KEYS --disable SYSTEM_REVOCATION_KEYS

          # æ‰¹é‡å¤„ç†é…ç½®æ–‡ä»¶
          handle_config() {
            file="$1"; mode="$2"
            [[ ! -f "$file" ]] && return
            while read -r line; do
              [[ -z "$line" || "$line" != CONFIG_* ]] && continue
              case "$mode" in
                enable)  scripts/config --enable "$line" ;;
                disable) scripts/config --disable "$line" ;;
                module)  scripts/config --module "$line" ;;
              esac
            done < "$file"
          }

          handle_config "${{ github.workspace }}/disabled_kernel_configs.txt" "disable"
          handle_config "${{ github.workspace }}/moduled_kernel_configs.txt" "module"
          handle_config "${{ github.workspace }}/enabled_kernel_configs.txt" "enable"

          make ARCH=${{ env.ARCH }} olddefconfig ${{ env.MAKE_ARGS }}
          mkdir -p ../configs && cp .config ../configs/final_build.config

      # è®¾ç½® Debian åŒ…ç›®æ ‡æ¶æ„
      - name: è®¾ç½®ç›®æ ‡ Debian æ¶æ„
        run: |
          if [[ "${{ inputs.arch }}" == "x86_64" ]]; then
            echo "DEB_HOST_ARCH=amd64" >> "$GITHUB_ENV"
          else
            echo "DEB_HOST_ARCH=arm64" >> "$GITHUB_ENV"
          fi

      # æ‰§è¡Œå†…æ ¸ç¼–è¯‘
      - name: ç¼–è¯‘å†…æ ¸ (${{ inputs.arch }})
        working-directory: kernel/linux
        timeout-minutes: 340
        run: |
          # æ„å»ºæœ¬åœ°ç‰ˆæœ¬æ ‡è¯†å­—ç¬¦ä¸²
          LOCAL_VER=""
          [[ "${{ inputs.enable_bbrv3 }}" == "true" ]] && LOCAL_VER="${LOCAL_VER}-bbrv3"
          LOCAL_VER="${LOCAL_VER}-${{ env.CACHE_KEY_COMPILER }}"
          [[ -n "${{ inputs.custom_suffix }}" ]] && LOCAL_VER="${LOCAL_VER}-${{ inputs.custom_suffix }}"
          LOCAL_VER="${LOCAL_VER}-${{ env.RAND_SUFFIX }}"
          make clean
          set +e
          make ARCH=${{ env.ARCH }} CROSS_COMPILE=${{ env.CROSS_COMPILE }} bindeb-pkg -j$(nproc) LOCALVERSION="$LOCAL_VER" ${{ env.MAKE_ARGS }} 2>&1 | tee ../build.log
          EXIT_CODE=${PIPESTATUS[0]}
          set -e
          if [[ $EXIT_CODE -ne 0 ]]; then
            tail -50 ../build.log
            exit 1
          fi

      # ä¿å­˜ ccache ç¼“å­˜ä¾›ä¸‹æ¬¡ä½¿ç”¨
      - name: ä¿å­˜ ccache
        uses: actions/cache/save@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: kernel-cache-${{ env.KERNEL_VERSION }}-${{ inputs.enable_bbrv3 }}-${{ env.CACHE_KEY_COMPILER }}-${{ inputs.arch }}

      # éªŒè¯ç¼–è¯‘äº§ç‰©å®Œæ•´æ€§
      - name: äº§ç‰©æ ¡éªŒ
        working-directory: kernel
        run: |
          count=$(ls *.deb 2>/dev/null | wc -l)
          [[ $count -gt 0 ]] || { echo "âŒ æœªæ‰¾åˆ° deb åŒ…"; exit 1; }
          for deb in *.deb; do
            size=$(stat -c%s "$deb")
            [[ $size -ge 102400 ]] || echo "âš ï¸ è­¦å‘Š: $deb æ–‡ä»¶è¿‡å° ($size bytes)"
          done

      # ç”Ÿæˆ SHA256 æ ¡éªŒæ–‡ä»¶
      - name: ç”Ÿæˆ checksum æ–‡ä»¶
        working-directory: kernel
        run: sha256sum *.deb > checksums.txt

      # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Actions Artifact
      - name: ä¸Šä¼  Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ env.KERNEL_VERSION }}-${{ env.RAND_SUFFIX }}-${{ env.DEB_HOST_ARCH }}
          path: |
            kernel/*.deb
            kernel/build.log
            kernel/configs/
            kernel/checksums.txt
          retention-days: 5

      # åˆ›å»º GitHub Release å¹¶ä¸Šä¼ 
      - name: å‘å¸ƒ Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.KERNEL_VERSION }}${{ env.CACHE_KEY_COMPILER != '' && format('-{0}', env.CACHE_KEY_COMPILER) || '' }}-${{ env.RAND_SUFFIX }}-${{ env.DEB_HOST_ARCH }}
          name: Linux ${{ env.KERNEL_VERSION }} ${{ env.FEATURE_TAG }} [${{ env.RAND_SUFFIX }}] (${{ env.DEB_HOST_ARCH }})
          files: |
            kernel/*.deb
            kernel/configs/final_build.config
            kernel/checksums.txt
          body: |
            ## ğŸ§ Linux Kernel ${{ env.KERNEL_VERSION }} Build

            **æ¶æ„**: ${{ inputs.arch }} (Debian: ${{ env.DEB_HOST_ARCH }})
            **æºç **: ${{ env.SOURCE_TYPE }}
            **BBRv3**: ${{ inputs.enable_bbrv3 && 'âœ…' || 'âŒ' }}
            **ç¼–è¯‘å™¨**: ${{ env.COMPILER_NAME }}
            **æ ‡è¯†**: `${{ env.RAND_SUFFIX }}`

            ### å®‰è£…æ–¹æ³•
            ```bash
            # ä¸‹è½½æ‰€æœ‰ .deb æ–‡ä»¶å’Œ checksums.txt
            # æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
            sha256sum -c checksums.txt
            # å®‰è£…å†…æ ¸ï¼ˆæ³¨æ„ä¾èµ–é¡ºåºï¼Œå»ºè®®ä¸€æ¬¡æ€§å®‰è£…ï¼‰
            sudo dpkg -i linux-image-*.deb linux-headers-*.deb
            # æˆ–ä½¿ç”¨ apt è‡ªåŠ¨å¤„ç†ä¾èµ–
            sudo apt install ./linux-image-*.deb ./linux-headers-*.deb
            ```

            **æ³¨æ„**ï¼šè¯·ç¡®ä¿ç³»ç»Ÿæ¶æ„åŒ¹é…ï¼Œå®‰è£…åé‡å¯ä»¥åº”ç”¨æ–°å†…æ ¸ã€‚
